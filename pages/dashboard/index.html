<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Victoria AI</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <!-- Header -->
    <header class="dashboard-header">
        <div class="header-container">
            <div class="logo">
                <img src="../../assets/logo_cropped.png" alt="Victoria AI">
                <span>Victoria AI</span>
            </div>
            <div class="user-menu">
                <div class="user-info" id="userInfo">
                    <div class="user-avatar" id="userAvatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <span class="user-name" id="userName">Loading...</span>
                </div>
                <button class="btn-settings" onclick="window.location.href='settings.html'">
                    <i class="fas fa-cog"></i>
                    <span>C√†i ƒê·∫∑t</span>
                </button>
                <button class="btn-logout" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>ƒêƒÉng xu·∫•t</span>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="dashboard-main">
        <div class="dashboard-container">
            <!-- Profile Incomplete Alert -->
            <div class="profile-alert" id="profileAlert" style="display: none;">
                <i class="fas fa-exclamation-triangle"></i>
                <div class="profile-alert-content">
                    <h3>H·ªì S∆° Ch∆∞a Ho√†n Thi·ªán</h3>
                    <p id="alertMessage">Vui l√≤ng c·∫≠p nh·∫≠t ƒë·∫ßy ƒë·ªß th√¥ng tin ƒë·ªÉ s·ª≠ d·ª•ng c√°c t√≠nh nƒÉng c·ªßa Victoria AI</p>
                </div>
                <button class="profile-alert-btn" onclick="window.location.href='settings.html'">
                    <i class="fas fa-arrow-right"></i> Ho√†n Thi·ªán Ngay
                </button>
            </div>

            <!-- Welcome Section -->
            <section class="welcome-section">
                <h1>Ch√†o m·ª´ng tr·ªü l·∫°i, <span id="welcomeName">User</span>! üëã</h1>
                <p>ƒê√¢y l√† trang qu·∫£n l√Ω t√†i kho·∫£n Victoria AI c·ªßa b·∫°n</p>
            </section>

            <!-- Stats Cards -->
            <section class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon stat-icon-blue">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="stat-content">
                        <h3>ƒê√£ x√°c th·ª±c</h3>
                        <p class="stat-value" id="emailVerified">Loading...</p>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon stat-icon-purple">
                        <i class="fas fa-calendar-alt"></i>
                    </div>
                    <div class="stat-content">
                        <h3>Tham gia t·ª´</h3>
                        <p class="stat-value" id="memberSince">Loading...</p>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon stat-icon-green">
                        <i class="fas fa-shield-alt"></i>
                    </div>
                    <div class="stat-content">
                        <h3>Ph∆∞∆°ng th·ª©c</h3>
                        <p class="stat-value" id="authMethod">Loading...</p>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon stat-icon-orange">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="stat-content">
                        <h3>ƒêƒÉng nh·∫≠p l·∫ßn cu·ªëi</h3>
                        <p class="stat-value" id="lastLogin">Loading...</p>
                    </div>
                </div>
            </section>

            <!-- User Profile Card -->
            <section class="profile-section">
                <div class="profile-card">
                    <h2>
                        <i class="fas fa-user-circle"></i>
                        Th√¥ng tin t√†i kho·∫£n
                    </h2>
                    
                    <div class="profile-details">
                        <div class="profile-item">
                            <label>
                                <i class="fas fa-signature"></i>
                                T√™n hi·ªÉn th·ªã
                            </label>
                            <p id="profileName">Loading...</p>
                        </div>

                        <div class="profile-item">
                            <label>
                                <i class="fas fa-envelope"></i>
                                Email
                            </label>
                            <p id="profileEmail">Loading...</p>
                        </div>

                        <div class="profile-item">
                            <label>
                                <i class="fas fa-fingerprint"></i>
                                User ID
                            </label>
                            <p id="profileUid" class="uid-text">Loading...</p>
                        </div>

                        <div class="profile-item">
                            <label>
                                <i class="fas fa-image"></i>
                                ·∫¢nh ƒë·∫°i di·ªán
                            </label>
                            <div class="profile-photo">
                                <img id="profilePhoto" src="" alt="Profile" style="display: none;">
                                <p id="profilePhotoText">Ch∆∞a c√≥ ·∫£nh ƒë·∫°i di·ªán</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Actions Card -->
                <div class="actions-card">
                    <h2>
                        <i class="fas fa-cog"></i>
                        H√†nh ƒë·ªông
                    </h2>
                    
                    <div class="action-buttons">
                        <button class="action-btn action-btn-primary">
                            <i class="fas fa-edit"></i>
                            <div>
                                <strong>Ch·ªânh s·ª≠a h·ªì s∆°</strong>
                                <span>C·∫≠p nh·∫≠t th√¥ng tin c√° nh√¢n</span>
                            </div>
                        </button>

                        <button class="action-btn action-btn-warning" id="changePasswordBtn">
                            <i class="fas fa-key"></i>
                            <div>
                                <strong>ƒê·ªïi m·∫≠t kh·∫©u</strong>
                                <span>C·∫≠p nh·∫≠t m·∫≠t kh·∫©u b·∫£o m·∫≠t</span>
                            </div>
                        </button>

                        <button class="action-btn action-btn-info" id="verifyEmailBtn" style="display: none;">
                            <i class="fas fa-envelope-open-text"></i>
                            <div>
                                <strong>X√°c th·ª±c Email</strong>
                                <span>G·ª≠i email x√°c th·ª±c</span>
                            </div>
                        </button>

                        <button class="action-btn action-btn-success">
                            <i class="fas fa-home"></i>
                            <div>
                                <strong>V·ªÅ trang ch·ªß</strong>
                                <span>Quay l·∫°i trang ch·ªß Victoria AI</span>
                            </div>
                        </button>
                    </div>
                </div>
            </section>

            <!-- Debug Info (Development) -->
            <section class="debug-section">
                <details>
                    <summary>
                        <i class="fas fa-bug"></i>
                        Debug Info (Developer)
                    </summary>
                    <pre id="debugInfo">Loading...</pre>
                </details>
            </section>
        </div>
    </main>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <p>ƒêang t·∫£i th√¥ng tin...</p>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, sendPasswordResetEmail, sendEmailVerification } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";
        
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyA8zc27rx6YIJoyoXyf7dugS-zCjazE6lU",
            authDomain: "victoria-908a3.firebaseapp.com",
            projectId: "victoria-908a3",
            storageBucket: "victoria-908a3.firebasestorage.app",
            messagingSenderId: "906906328836",
            appId: "1:906906328836:web:b050d66d1b178f03f4fa51",
            measurementId: "G-DGG9GE81Z7"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // Save or update user profile in Firestore
        async function saveUserProfile(user) {
            try {
                const userRef = doc(db, 'users', user.uid);
                const userSnap = await getDoc(userRef);
                
                const userData = {
                    displayName: user.displayName || 'User',
                    email: user.email,
                    photoURL: user.photoURL || null,
                    emailVerified: user.emailVerified,
                    lastLogin: serverTimestamp(),
                    authProvider: user.providerData[0]?.providerId || 'unknown'
                };
                
                if (!userSnap.exists()) {
                    // First time login - create profile
                    userData.createdAt = serverTimestamp();
                    await setDoc(userRef, userData);
                    console.log('‚úÖ User profile created in Firestore');
                } else {
                    // Update existing profile
                    await updateDoc(userRef, userData);
                    console.log('‚úÖ User profile updated in Firestore');
                }
                
                return userData;
            } catch (error) {
                console.warn('‚ö†Ô∏è Firestore not available:', error.code);
                if (error.code === 'permission-denied' || error.code === 'not-found') {
                    console.info('üí° Tip: Create Firestore database in Firebase Console first');
                }
                // Return null but don't crash - app works without Firestore
                return null;
            }
        }
        
        // Format date helper
        function formatDate(timestamp) {
            if (!timestamp) return 'Kh√¥ng x√°c ƒë·ªãnh';
            const date = new Date(timestamp);
            return date.toLocaleDateString('vi-VN', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        // Check authentication and load user data
        onAuthStateChanged(auth, async (user) => {
            const loadingOverlay = document.getElementById('loadingOverlay');
            
            if (user) {
                // User is signed in
                console.log('User logged in:', user);
                
                // Save/update user profile in Firestore (non-blocking)
                saveUserProfile(user).catch(err => {
                    console.warn('Firestore sync skipped:', err.code);
                });
                
                // Check profile completeness
                await checkProfileCompleteness(user);
                
                // Update UI with user data
                document.getElementById('userName').textContent = user.displayName || 'User';
                document.getElementById('welcomeName').textContent = user.displayName || 'User';
                document.getElementById('profileName').textContent = user.displayName || 'Ch∆∞a c√≥ t√™n';
                document.getElementById('profileEmail').textContent = user.email;
                document.getElementById('profileUid').textContent = user.uid;
                
                // Email verification status
                const emailVerified = user.emailVerified ? 
                    '<span class="badge badge-success">‚úì ƒê√£ x√°c th·ª±c</span>' : 
                    '<span class="badge badge-warning">‚ö† Ch∆∞a x√°c th·ª±c</span>';
                document.getElementById('emailVerified').innerHTML = emailVerified;
                
                // Show verify button if not verified
                if (!user.emailVerified && user.providerData[0]?.providerId === 'password') {
                    document.getElementById('verifyEmailBtn').style.display = 'flex';
                }
                
                // Member since
                document.getElementById('memberSince').textContent = formatDate(user.metadata.creationTime);
                
                // Last login
                document.getElementById('lastLogin').textContent = formatDate(user.metadata.lastSignInTime);
                
                // Auth method
                const provider = user.providerData[0]?.providerId || 'unknown';
                let authMethodText = 'Email/Password';
                if (provider === 'google.com') {
                    authMethodText = '<i class="fab fa-google"></i> Google';
                }
                document.getElementById('authMethod').innerHTML = authMethodText;
                
                // Profile photo
                if (user.photoURL) {
                    document.getElementById('profilePhoto').src = user.photoURL;
                    document.getElementById('profilePhoto').style.display = 'block';
                    document.getElementById('profilePhotoText').style.display = 'none';
                    
                    // Update avatar in header
                    const avatarContainer = document.getElementById('userAvatar');
                    avatarContainer.innerHTML = `<img src="${user.photoURL}" alt="Avatar">`;
                }
                
                // Debug info
                document.getElementById('debugInfo').textContent = JSON.stringify({
                    uid: user.uid,
                    email: user.email,
                    displayName: user.displayName,
                    photoURL: user.photoURL,
                    emailVerified: user.emailVerified,
                    providerData: user.providerData,
                    metadata: user.metadata
                }, null, 2);
                
                // Hide loading
                loadingOverlay.style.display = 'none';
                
            } else {
                // No user signed in, redirect to signin
                console.log('No user logged in, redirecting...');
                window.location.href = '../auth/signin.html';
            }
        });
        
        // Logout handler
        document.getElementById('logoutBtn').addEventListener('click', async () => {
            if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën ƒëƒÉng xu·∫•t?')) {
                try {
                    await signOut(auth);
                    window.location.href = '../auth/signin.html';
                } catch (error) {
                    console.error('Logout error:', error);
                    alert('ƒêƒÉng xu·∫•t th·∫•t b·∫°i: ' + error.message);
                }
            }
        });
        
        // Change password handler
        document.getElementById('changePasswordBtn').addEventListener('click', async () => {
            const user = auth.currentUser;
            if (!user) return;
            
            if (user.providerData[0]?.providerId === 'google.com') {
                alert('B·∫°n ƒëƒÉng nh·∫≠p b·∫±ng Google. Kh√¥ng th·ªÉ ƒë·ªïi m·∫≠t kh·∫©u t·ª´ ƒë√¢y.');
                return;
            }
            
            if (confirm(`G·ª≠i email ƒë·∫∑t l·∫°i m·∫≠t kh·∫©u ƒë·∫øn ${user.email}?`)) {
                try {
                    await sendPasswordResetEmail(auth, user.email);
                    alert('Email ƒë·∫∑t l·∫°i m·∫≠t kh·∫©u ƒë√£ ƒë∆∞·ª£c g·ª≠i! Vui l√≤ng ki·ªÉm tra h·ªôp th∆∞.');
                } catch (error) {
                    console.error('Password reset error:', error);
                    alert('G·ª≠i email th·∫•t b·∫°i: ' + error.message);
                }
            }
        });
        
        // Verify email handler
        const verifyBtn = document.getElementById('verifyEmailBtn');
        if (verifyBtn) {
            verifyBtn.addEventListener('click', async () => {
                const user = auth.currentUser;
                if (!user) return;
                
                try {
                    await sendEmailVerification(user);
                    alert('Email x√°c th·ª±c ƒë√£ ƒë∆∞·ª£c g·ª≠i! Vui l√≤ng ki·ªÉm tra h·ªôp th∆∞ v√† l√†m theo h∆∞·ªõng d·∫´n.');
                } catch (error) {
                    console.error('Email verification error:', error);
                    alert('G·ª≠i email th·∫•t b·∫°i: ' + error.message);
                }
            });
        }
        
        // Back to home handler
        document.querySelector('.action-btn-success').addEventListener('click', () => {
            window.location.href = '../../index.html';
        });
        
        // Check profile completeness
        async function checkProfileCompleteness(user) {
            try {
                const token = await user.getIdToken();
                const API_BASE = 'https://bkuteam.site/php/api/profile';
                
                const response = await fetch(`${API_BASE}/check-complete.php`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                console.log('Check complete response:', response.status);
                
                if (!response.ok) {
                    console.warn('Check complete API failed:', response.status);
                    return;
                }
                
                const result = await response.json();
                console.log('Profile completeness:', result);
                
                if (result.success) {
                    if (!result.data.complete) {
                        // Show alert banner
                        const alertEl = document.getElementById('profileAlert');
                        const messageEl = document.getElementById('alertMessage');
                        
                        if (result.data.missing_fields && result.data.missing_fields.length > 0) {
                            const fields = result.data.missing_fields.map(f => f.label || f).join(', ');
                            messageEl.textContent = `C√≤n thi·∫øu: ${fields}. Vui l√≤ng c·∫≠p nh·∫≠t ƒë·ªÉ s·ª≠ d·ª•ng ƒë·∫ßy ƒë·ªß t√≠nh nƒÉng.`;
                        } else if (!result.data.role) {
                            messageEl.textContent = 'Vui l√≤ng ch·ªçn vai tr√≤ (Sinh vi√™n/Gi·∫£ng vi√™n) v√† c·∫≠p nh·∫≠t th√¥ng tin.';
                        }
                        
                        alertEl.style.display = 'flex';
                        console.log('‚úÖ Banner displayed');
                    } else {
                        console.log('‚úÖ Profile is complete - no banner needed');
                    }
                }
            } catch (error) {
                console.error('Check profile error:', error);
                // Kh√¥ng hi·ªÉn th·ªã l·ªói cho user, ch·ªâ log
            }
        }
    </script>
</body>
</html>
